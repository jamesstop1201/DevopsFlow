# DevOps 專案：Mini Finance 自動化雲端架構

本手冊詳述了如何構建一個生產級別的雲端環境

---

## 第一階段：引導啟動 (Bootstrap - Remote State)
1. **編寫管理層代碼**：建立 `S3 Bucket`（存儲狀態檔）與 `DynamoDB`（狀態鎖）。
2. **本地執行啟動**：
   - 執行 `terraform init` (此時為 Local Backend)。
   - 執行 `terraform apply` 建立儲存資源。
3. **產出物**：獲得一個專屬的 S3 Bucket 名稱，供主專案後續使用。

---

## 第二階段：基礎設施撥備 (IaC - Terraform)
1. **配置 Backend**：在 `main.tf` 中加入 `backend "s3"`，指向第一階段建立的資源。
2. **網絡層 (VPC)**：
   - 建立 Public Subnets (放置 ALB, Jenkins)。
   - 建立 Private Subnets (放置 EKS Node Group，確保內網安全)。
3. **核心資源層**：
   - **ECR**：建立鏡像倉庫，開啟 `scan_on_push` 漏洞掃描。
   - **Jenkins EC2**：建立執行個體並配置 IAM Role。
   - **EKS Cluster**：建立 Kubernetes 叢集，並設定 **Node Group Auto Scaling** (Min: 2, Max: 5)。

---

## 第三階段：環境自動化配置 (Configuration - Ansible)
1. **連線設定**：配置 `inventory/hosts.ini`，指向 Jenkins EC2 IP。
2. **自動化安裝**：執行 Playbook 安裝以下工具：
   - **Docker**：打包鏡像。
   - **Java 17 & Jenkins**：運行流水線。
   - **kubectl & aws-cli**：下達 K8s 與 AWS 指令。
3. **權限驗證**：確保 Jenkins 帳號有權限執行 Docker 命令。

---

## 第四階段：持續整合 (CI - Docker & Jenkins)
1. **Dockerfile 撰寫**：以 `nginx:alpine` 為基底，將靜態網頁 `COPY` 進入容器。
2. **流水線定義**：在 `Jenkinsfile` 中定義：
   - **Build**：執行 `docker build`。
   - **Push**：將鏡像推送到 AWS ECR，並標記 Commit ID 版本。

---

## 第五階段：高可用部署與自動擴展 (CD & K8s)
1. **部署 Deployment**：配置 2 個副本，引用 ECR 中的最新鏡像。
2. **配置 HPA (Auto Scaling)**：
   - 建立 `web-hpa.yaml`。
   - 設定當 CPU 使用率 > 50% 時，自動擴展至最高 10 個 Pod。
3. **流量參照 (Ingress)**：
   - 部署 Ingress 資源，觸發 **AWS ALB (Port 80)** 的建立。

---

## 第六階段：網域與接入 (Route 53)
1. **DNS 配置**：
   - 在 Route 53 建立 **A 紀錄 (Alias)**。
   - 將你的域名指向 ALB 的 DNS 地址。
2. **HTTP 存取**：使用者輸入網址，流量經 ALB 均勻分配至各個 Pod。

---

## 第七階段：SQE 質量驗證 (Validation)
1. **基礎設施測試**：驗證 `terraform plan` 是否與預期一致。
2. **壓力測試 (Scaling Test)**：使用壓測工具模擬流量，觀察 HPA 是否自動增加 Pod 數量。
3. **自癒能力測試 (Self-healing)**：手動刪除 Pod，驗證 K8s 是否自動拉起新 Pod。
4. **零停機發佈測試**：在 Pipeline 部署期間刷新網頁，驗證無中斷 (Rolling Update)。