# Mini Financeï½œTerraform Ã— Ansible Ã— Jenkins å®Œæ•´æµç¨‹èˆ‡å•é¡Œè™•ç†ç­†è¨˜

---

## ä¸€ã€Terraform ç®¡ç†å±¤åˆå§‹åŒ–æµç¨‹

### æ“ä½œæ­¥é©Ÿ

1. æ’°å¯«ç®¡ç†å±¤è¨­å®šæª”
infra-terraform/management/main.yaml

2. åˆå§‹åŒ–èˆ‡éƒ¨ç½²
cd infra-terraform/management/
terraform init
terraform plan
terraform apply

3. è«‹å‹™å¿…ä¿ç•™ Terraform è¼¸å‡ºå€¼
- state_bucket_name  
æ­¤å€¼æœƒåœ¨å¾ŒçºŒæ‰€æœ‰ module ä½œç‚º remote state ä½¿ç”¨

---

## äºŒã€å»ºç«‹ SSH é‡‘é‘°ï¼ˆä¾› Jenkins / Ansible ä½¿ç”¨ï¼‰

### å»ºç«‹å­˜æ”¾é‡‘é‘°çš„è³‡æ–™å¤¾ï¼ˆå¦‚æœå°šæœªå­˜åœ¨ï¼‰
mkdir -p ~/.ssh

### ç”¢ç”Ÿ SSH é‡‘é‘°å°
ssh-keygen -t rsa -b 4096 -f ~/.ssh/mini-finance-key -N ""

### ç”¢ç”Ÿçš„æª”æ¡ˆèªªæ˜
- mini-finance-key  
  ç§é‘°ï¼ˆç­‰åŒèº«åˆ†è­‰ï¼Œç¦æ­¢ä¸Šå‚³ Gitã€ç¦æ­¢å¤–æµï¼‰

- mini-finance-key.pub  
  å…¬é‘°ï¼ˆæä¾›çµ¦ AWS EC2 ä½¿ç”¨ï¼‰

---

## ä¸‰ã€SSH é€£ç·šéŒ¯èª¤çš„æ ¸å¿ƒåŸå› åˆ†æ

### å•é¡Œ 1ï¼šHost key verification failed
- SSH çš„å®‰å…¨æ©Ÿåˆ¶
- Jenkins ç¬¬ä¸€æ¬¡é€£ç·š EC2
- EC2 å°šæœªå­˜åœ¨æ–¼ Jenkins çš„ known_hosts
- è‡ªå‹•åŒ–æµç¨‹ç„¡æ³•è¼¸å…¥ yes
- å› æ­¤ç›´æ¥ä¸­æ–·é€£ç·š

### å•é¡Œ 2ï¼šssh_askpass
- é€£ç·šå¤±æ•—å¾Œå˜—è©¦è¦æ±‚è¼¸å…¥å¯†ç¢¼
- Jenkins / Server ç’°å¢ƒæ²’æœ‰ GUI
- å°è‡´ ssh_askpass éŒ¯èª¤

---

## å››ã€è§£æ±ºæ–¹å¼ï¼ˆæ“‡ä¸€å³å¯ï¼‰

### æ–¹æ³• Aï¼šåœ¨ Jenkins Pipeline é—œé–‰ SSH ä¸»æ©Ÿæª¢æŸ¥ï¼ˆæœ€æ¨è–¦ï¼‰

åœ¨ Jenkinsfile æˆ– Shell è…³æœ¬ä¸­åŠ å…¥ï¼š

export ANSIBLE_HOST_KEY_CHECKING=False
ansible-playbook -i inventory my-playbook.yml

é©åˆæƒ…å¢ƒï¼š
- CI/CD
- Jenkins Pipeline
- å…¨è‡ªå‹•éƒ¨ç½²æµç¨‹

---

### æ–¹æ³• Bï¼šé€é ansible.cfg é—œé–‰ä¸»æ©Ÿæª¢æŸ¥

åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„æˆ– Ansible ç›®éŒ„å»ºç«‹ ansible.cfgï¼š

[defaults]
host_key_checking = False

---

## äº”ã€WSL æª”æ¡ˆæ¬Šé™å•é¡Œï¼ˆchmod ç„¡æ•ˆï¼‰

### å•é¡Œèªªæ˜
- /mnt/cã€/mnt/d ä¸‹çš„æª”æ¡ˆ
- é è¨­ä¸æ”¯æ´ Linux æª”æ¡ˆæ¬Šé™
- chmod çœ‹ä¼¼æˆåŠŸä½†å¯¦éš›ç„¡æ•ˆ

### è§£æ³•ï¼šè¨­å®š WSL automount

1. ç·¨è¼¯è¨­å®šæª”
sudo vi /etc/wsl.conf

2. åŠ å…¥ä»¥ä¸‹å…§å®¹
[automount]
options = "metadata,umask=22,fmask=11"

3. é‡æ–°å•Ÿå‹• WSLï¼ˆåœ¨ PowerShell åŸ·è¡Œï¼‰
wsl --shutdown

4. é‡æ–°é–‹å•Ÿ WSL å¾Œå†æ¸¬è©¦
chmod 644 ansible.cfg

---

## å…­ã€å–å¾— Jenkins åˆå§‹ç®¡ç†å“¡å¯†ç¢¼

### èªªæ˜
- Jenkins åŸºæ–¼å®‰å…¨æ€§ï¼Œé¦–æ¬¡å•Ÿå‹•æœƒé–ä½
- å¿…é ˆè¼¸å…¥ Initial Admin Password æ‰èƒ½ç™»å…¥ Web UI

### å¾æœ¬æ©Ÿç›´æ¥æŠ“å–å¯†ç¢¼
ssh -i ~/.ssh/mini-finance-key ubuntu@<ä½ çš„_JENKINS_IP> "sudo cat /var/lib/jenkins/secrets/initialAdminPassword"
ssh -i ~/.ssh/mini-finance-key ubuntu@50.19.182.98 "sudo cat /var/lib/jenkins/secrets/initialAdminPassword"
http://54.210.121.215:8080/pipeline-syntax/globals#env
---


jenkinsèº«åˆ†åŸ·è¡Œdocker æ¬Šé™æ›´æ”¹
ğŸ› ï¸ å¿«é€Ÿè§£æ±ºæ–¹æ¡ˆ (æ‰‹å‹•ä¿®æ­£)
è«‹ SSH é€²å…¥ä½ çš„ Jenkins EC2 ä¼ºæœå™¨ï¼Œç›´æ¥åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

Bash

# 1. ç¢ºä¿ jenkins ä½¿ç”¨è€…åœ¨ docker ç¾¤çµ„
sudo usermod -aG docker jenkins

# 2. æš«æ™‚çµ¦äºˆ docker.sock æ¬Šé™ (æœ€å¿«ï¼Œç«‹å³è¦‹æ•ˆ)
sudo chmod 666 /var/run/docker.sock

# 3. å‹™å¿…é‡å•Ÿ Jenkins æœå‹™ï¼Œè®“å®ƒå¸¶å…¥æ–°çš„ç¾¤çµ„æ¬Šé™
sudo systemctl restart jenkins



----------------------------------------------------------------------------------------------
ç¬¬ä¸€æ­¥ï¼šç’°å¢ƒæ¬Šé™ã€Œå¤§æ¸…æ´—ã€
æˆ‘å€‘å…ˆç¢ºä¿ Jenkins å¸³è™Ÿçš„èº«åˆ†å’Œå·¥å…·æ˜¯ 100% æ­£ç¢ºçš„ï¼š

Bash

# 1. åˆªé™¤æ‰€æœ‰èˆŠçš„å¿«å–èˆ‡è¨­å®š
rm -rf ~/.kube
sudo rm -rf /var/lib/jenkins/.kube

# 2. æ›´æ–° AWS CLI åˆ°æœ€æ–°ç‰ˆ (é¿å… v1alpha1 éŒ¯èª¤)
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
sudo apt install unzip
unzip -o awscliv2.zip
sudo ./aws/install --update

ç¬¬äºŒæ­¥ï¼šé‡æ–°é ˜å– EKS é‘°åŒ™ä¸¦ä¿®æ­£æ ¼å¼
é€™æ˜¯ä¹‹å‰å¡é—œæœ€ä¹…çš„åœ°æ–¹ï¼Œé€™æ¬¡æˆ‘å€‘ç”¨æœ€ç²¾ç¢ºçš„æŒ‡ä»¤ä¸€æ¬¡åˆ°ä½ï¼š

Bash

# 1. é ˜å–é‘°åŒ™
aws eks update-kubeconfig --region us-east-1 --name mini-finance-cluster

# 2. å¼·åˆ¶æŠŠ API ç‰ˆæœ¬ä¿®æ­£ç‚º v1beta1
sed -i 's/v1alpha1/v1beta1/g' ~/.kube/config

# 3. æ¸¬è©¦ä½ ç›®å‰çš„ ubuntu å¸³è™Ÿæ˜¯å¦èƒ½é€£é€š
kubectl get nodes
(å¦‚æœé€™æ­¥æˆåŠŸå°å‡ºç¯€é»ï¼Œè«‹ç¹¼çºŒï¼›å¦‚æœæ²’å°å‡ºï¼Œä»£è¡¨ WSL2 çš„ Access Entry æ¬Šé™è¦é‡çµ¦)

ç¬¬ä¸‰æ­¥ï¼šå°‡æ¬Šé™ã€ŒåŒæ­¥ã€çµ¦ Jenkins æœå‹™
Jenkins ç¶²é æ˜¯åœ¨ jenkins é€™å€‹ç³»çµ±å¸³è™Ÿä¸‹åŸ·è¡Œçš„ï¼Œæ‰€ä»¥å®ƒå¿…é ˆæœ‰è‡ªå·±çš„é‘°åŒ™ï¼š

Bash

# 1. å»ºç«‹ç›®éŒ„ä¸¦è¤‡è£½è¨­å®š
sudo mkdir -p /var/lib/jenkins/.kube
sudo cp ~/.kube/config /var/lib/jenkins/.kube/config

# 2. æ›´æ”¹æ¬Šé™è®“ Jenkins å¸³è™Ÿå¯ä»¥è®€å–
sudo chown -R jenkins:jenkins /var/lib/jenkins/.kube

# 3. æœ€çµ‚é©—è­‰ï¼šä»¥ Jenkins èº«åˆ†åŸ·è¡Œæ¸¬è©¦
sudo -u jenkins kubectl get nodes




# 1. ç›´æ¥çµ¦ Jenkins è§’è‰²æœ€é«˜æ¬Šé™ (è§£æ±º AccessDenied)
aws iam attach-role-policy \
    --role-name mini-finance-jenkins-role \
    --policy-arn arn:aws:iam::aws:policy/AdministratorAccess

# 2. å°‡ Jenkins è§’è‰²åŠ å…¥ EKS å­˜å–åå–®
aws eks create-access-entry \
    --cluster-name mini-finance-cluster \
    --principal-arn arn:aws:iam::514015205949:role/mini-finance-jenkins-role \
    --type STANDARD

# 3. é—œè¯ç®¡ç†æ”¿ç­–
aws eks associate-access-policy \
    --cluster-name mini-finance-cluster \
    --principal-arn arn:aws:iam::514015205949:role/mini-finance-jenkins-role \
    --policy-arn arn:aws:iam::aws:policy/AmazonEKSClusterAdminPolicy \
    --access-scope type=cluster

# åœ¨æœ¬åœ°é›»è…¦åŸ·è¡Œï¼Œå°‡é©—è­‰æ¨¡å¼æ”¹ç‚ºæ”¯æ´ API
aws eks update-cluster-config \
    --name mini-finance-cluster \
    --access-config authenticationMode=API_AND_CONFIG_MAP


åœ¨ä½ çš„ æœ¬åœ°é›»è…¦ é‡æ–°åŸ·è¡Œé€™æ¢æŒ‡ä»¤ï¼Œè«‹æ³¨æ„ policy-arn çš„å®Œæ•´è·¯å¾‘ï¼š

Bash

aws eks associate-access-policy \
    --cluster-name mini-finance-cluster \
    --principal-arn arn:aws:iam::514015205949:role/mini-finance-jenkins-role \
    --policy-arn arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy \
    --access-scope type=cluster

åœ¨ Jenkins ä¼ºæœå™¨ä¸Šï¼Œä»¥ ubuntu èº«ä»½åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œé‡æ–°æŠ“å–æ­£ç¢ºçš„ EKS ä½å€ï¼š

Bash

# 1. å¼·åˆ¶æ›´æ–° ubuntu çš„ kubeconfig
aws eks update-kubeconfig --region us-east-1 --name mini-finance-cluster

# 2. åŒæ­¥çµ¦ jenkins ä½¿ç”¨è€… (é€™æ˜¯é—œéµ)
sudo cp -r ~/.kube /var/lib/jenkins/
sudo chown -R jenkins:jenkins /var/lib/jenkins/.kube

# 3. å†æ¬¡æ¸¬è©¦
sudo -u jenkins kubectl get nodes




## ğŸ› ï¸ Jenkins å®‰è£ç’°å¢ƒè¦ç¯„ (Version 2.547)
æœ¬å°ˆæ¡ˆæŒ‡å®šçš„ Jenkins ç‰ˆæœ¬å…·æœ‰ç‰¹å®šçš„ç’°å¢ƒç›¸ä¾æ€§ï¼Œéƒ¨ç½²å‰è«‹å‹™å¿…ç¢ºèªä»¥ä¸‹é…ç½®ï¼š

1. Java ç‰ˆæœ¬è¦æ±‚
æŒ‡å®šç‰ˆæœ¬ï¼šJava 21 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚

èªªæ˜ï¼šè‡ª Jenkins 2.545 ç‰ˆæœ¬èµ·ï¼Œå®˜æ–¹å·²æ­£å¼ç§»é™¤å° Java 17 çš„æ”¯æ´ã€‚é‡å° 2.547 (Weekly) ç‰ˆæœ¬ï¼Œç³»çµ±ç’°å¢ƒå¿…é ˆå‡ç´šè‡³ Java 21ï¼Œå¦å‰‡ Jenkins æœå‹™å°‡ç„¡æ³•æ­£å¸¸å•Ÿå‹•ï¼ˆæœƒå°è‡´ jenkins.service failedï¼‰ã€‚

æª¢æŸ¥æŒ‡ä»¤ï¼š

```Bash
java -version  # è¼¸å‡ºæ‡‰åŒ…å« 21.x.x
```

2. GPG é‡‘é‘°èˆ‡ä¾†æºé »é“
é‡‘é‘°ç‰ˆæœ¬ï¼šjenkins.io-2026.key

é‡‘é‘°èªªæ˜ï¼šç‚ºé…åˆ 2026 å¹´æœ€æ–°çš„å®‰å…¨ç°½ç½²è¦ç¯„ï¼Œå¿…é ˆä½¿ç”¨ 2026 ç‰ˆé‡‘é‘°é€²è¡Œé©—è­‰ã€‚

è»Ÿé«”æºé »é“ï¼šdebian (Weekly)ã€‚

æ³¨æ„ï¼šä¸å¯ä½¿ç”¨ debian-stableï¼Œå¦å‰‡æœƒç™¼ç”Ÿæ‰¾ä¸åˆ° 2.547 å¥—ä»¶çš„éŒ¯èª¤ã€‚

3. Ansible éƒ¨ç½²é‚è¼¯
ç‚ºäº†ç¢ºä¿éƒ¨ç½²çš„ç©©å®šæ€§ï¼Œæœ¬å°ˆæ¡ˆçš„ Ansible ä»»å‹™ æ¡ç”¨åŸç”Ÿæ¨¡çµ„å¯¦ä½œï¼š

get_url æ¨¡çµ„ï¼šå¼·åˆ¶ä¸‹è¼‰æœ€æ–°çš„ 2026.key ä¸¦è¨­å®š 644 æ¬Šé™ï¼Œç¢ºä¿ apt ç³»çµ±èƒ½å®‰å…¨è®€å–ã€‚

copy æ¨¡çµ„ï¼šæ§åˆ¶ jenkins.list å…§å®¹ï¼Œä¸¦ä½¿ç”¨ç¾ä»£åŒ–çš„ [signed-by] èªæ³•å°‡ä¾†æºèˆ‡ç‰¹å®šé‡‘é‘°ç¶å®šï¼Œé¿é–‹èˆŠå¼ apt-key çš„å®‰å…¨æ€§è­¦å‘Šã€‚

<!-- > * **DNS è§£æ**ï¼šä½¿ç”¨è€…å­˜å– URL æ™‚ï¼Œé¦–å…ˆç¶“ç”± **GoDaddy** è§£æï¼ŒæŒ‡å¼•è‡³ **AWS Route 53**ã€‚ -->
